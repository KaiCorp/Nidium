#!/usr/bin/env python2.7

# Copyright 2016 Nidium Inc. All rights reserved.
# Use of this source code is governed by a MIT license
# that can be found in the LICENSE file.

import os

from konstructor import Deps
from konstructor import CommandLine
from konstructor import Build
from konstructor import Builder
from konstructor import Platform
from konstructor import Variables
from konstructor import Konstruct
from konstructor import Tests
from konstructor import Utils
from konstructor import Log
from konstructor import ROOT, OUTPUT

Deps.set(
    "libnspr4",
    "mozilla-central",
    "leveldb",
    "http-parser",
    "jsoncpp",
    Deps.Konstruct("network", "src/libapenetwork/configure")
)

if Platform.system == "Darwin":
    Platform.setEnviron("CXXFLAGS+=-stdlib=libc++ -mmacosx-version-min=10.7")
    Platform.setEnviron("CPPFLAGS+=-stdlib=libc++ -mmacosx-version-min=10.7")
    # Some third-party libraries (skia, angle, mozilla-central)
    # produce binaries. So we need to set LDFLAGS too.
    Platform.setEnviron("LDFLAGS+=-stdlib=libc++ -mmacosx-version-min=10.7")
elif Platform.system == "Windows":
   Platform.setCompiler("cl", "cl")
   Platform.setEnviron("LD=Link")
   Platform.setEnviron("AR=lib")
   Deps.set('pthreads4w')

DEPEDENCY_REPO = Variables.get("depsRepo")
CONFIGURE_PATH = os.path.dirname(os.path.realpath(__file__))
Gyp = Builder.Gyp

@Deps.register("leveldb")
def leveldb():
    make_opt = ''
    ext = '.a'
    if Platform.system == "Darwin":
        ext = '.lib'
    cxxFlags = Platform.getEnviron("CXXFLAGS", "")
    if Platform.system == "Windows":
        #parallel build seems to lock make
        make_opt += " -j1"
        #tell make to ignore the shared libray, just create the static one
        make_opt += " libleveldb%s" % (ext)
        cxxFlags += " -EHsc -MD"
        Platform.setEnviron('TARGET_OS=NATIVE_WINDOWS')
        Platform.setEnviron('AR_FLAGS=-nologo -out:')
        Platform.setEnviron("CXXFLAGS=%s" % (cxxFlags))
        patch = [os.path.join(CONFIGURE_PATH, "patch", "leveldb_windows.patch")]
        build = ["make clean", "make" + make_opt]
    else:
        patch = [os.path.join(CONFIGURE_PATH, "patch", "leveldb.patch")]
        build = ["make clean", "CXXFLAGS=%s make %s" % (cxxFlags, make_opt)]
        if Konstruct.config("asan"):
            # Fix ASAN container overflow false positive :
            # https://github.com/google/sanitizers/wiki/AddressSanitizerContainerOverflow#false-positives
            cxxFlags += " -fsanitize=address"
    return {
        "location": Deps.GitRepo("https://github.com/bitcoin-core/leveldb.git", revision="d40bc3f"),
        # leveldb make doest not detect CXXFLAGS changes, so we force "make clean"
        "build": build,
        "patchs": patch,
        "outputs": ["libleveldb%s" % (ext)]
    }

@Deps.register("icu")
def icu():
    Platform.setEnviron("CXXFLAGS=-MD")
    Platform.setEnviron("CFLAGS=-MD")
    return {
        "chdir": "./mozilla-central/intl/icu",
        "build": [  Platform.MsBuild("source/common/common.vcxproj"),
                    Platform.MsBuild("source/stubdata/stubdata.vcxproj"),
                    Platform.MsBuild("source/i18n/i18n.vcxproj")
                ],
        "outputs": ["lib/%s.lib" % (l) for l in ["icuin", "icuuc", "icudt"] ]
        }

@Deps.register("libnspr4")
def libnspr():
    ext = '.a'
    postfix= ''
    outputs =  []
    if Platform.system == "Windows":
        ext = '.lib'
        postfix= '_s'
        make = "mozmake -j1"
        configure = "bash ./configure --disable-static-rtl "
        outputs + [ "dist/lib/lib%s4%s_s%s" % (l, postfix, ext) for l in ['nspr', 'plc', 'plds']]
    else:
        make = "make"
        configure = "./configure"
    if Platform.wordSize == 64:
        configure += " --enable-64bit"
    configure += " --disable-debug \
                   --enable-optimize \
                   --enable-strip \
                   --disable-nspr-threads"
    outputs = outputs + [ "dist/lib/lib%s4%s%s" % (l, postfix, ext) for l in ['nspr', 'plc', 'plds']]
    return {
        "chdir": "mozilla-central/nsprpub/",
        "build": [configure, make],
        "outputs": outputs
    }

@Deps.register("mozilla-central")
def mozilla():
    Platform.setEnviron("TARGET_CPU=%s" % (["x86","x64"][Platform.wordSize == 64]))
    nsprDir = os.path.realpath(os.path.join("mozilla-central/nsprpub/")).replace('\\', '/')
    nsprFlags = '--with-nspr-cflags="-I%s/dist/include/nspr/"' % (nsprDir)
    if Platform.system == "Windows":
        Platform.setEnviron("CXXFLAGS=-MD")
        Platform.setEnviron("CFLAGS=-MD")
        patch = [os.path.join(CONFIGURE_PATH, "patch", "mozilla-central_windows.patch")]
        make = "mozmake"
        configure = "bash ../configure --enable-build-backend=VisualStudio"
        if Platform.wordSize == 64:
            configure += " --target=x86_64-pc-mingw32 --host=x86_64-pc-mingw32"
        nsprFlags += ''' --with-nspr-libs="'%s/dist/lib/libnspr4' '%s/dist/lib/libplds4' '%s/dist/lib/libplc4'"''' % (nsprDir, nsprDir, nsprDir)
        outputs = ["mozglue/build/mozglue.lib$", "js/src/js_static.lib$", "js/src/Initialization.obj"] \
                + ["mfbt/staticruntime/%s.obj" % (l) for l in ["Compression", "Decimal", "Unified_cpp_mfbt_staticruntime0"] ] \
                + ["intl/icu/target/lib/%s.lib" % (l) for l in ["icuin", "icuuc", "icudt"] ]
    else:
        make = "make"
        patch = []
        configure = "../configure"
        nsprFlags += ' --with-nspr-libs="-L%s/dist/lib/ -lnspr4 -lplds4 -lplc4"' % (nsprDir)
        outputs = ["mozglue/build/libmozglue.a$", "js/src/libjs_static.a$"]
    configure += " --disable-shared-js \
                   --disable-jemalloc \
                   --disable-tests \
                   --enable-ctypes %s" % (nsprFlags)
    if Konstruct.config("debug", "valgrind"):
        if Platform.system != "Windows":
            configure += " --enable-debug --disable-optimize"
    else:
        configure += " --enable-strip --enable-release"

    if Konstruct.config("valgrind"):
        configure += " --enable-valgrind "

    return {
        "chdir": "js/src/obj",
        "location": DEPEDENCY_REPO + "/mozjs-45.5.3.tar.bz2",
        "build": [configure, make],
        "patchs": patch,
        "outputs": outputs + ["js/src/js-config.h$"]
    }

@Deps.register("http-parser")
def httpParser():
    if Platform.system == "Windows":
        platform = ["Win32", "x64"][Platform.wordSize == 64]
        gyp = "..\gyp\gyp.bat --depth . -DOS=win -f msvs"
        gyp += " -G Platform=%s -Dplatform=%s" % (platform, platform)
        build = [gyp, Platform.MsBuild("http_parser.vcxproj")]
        output = "Release/lib/http_parser.lib"
        patch = [os.path.join(CONFIGURE_PATH, "patch", "http_parser_windows.patch")]
    else:
        build = ["make package"]
        output = "libhttp_parser.a"
        patch = []
    return {
        "location": Deps.GitRepo("https://github.com/nodejs/http-parser.git", tag="v2.6.2"),
        "patchs": patch,
        "build": build,
        "outputs": [output]
    }

@Deps.register("jsoncpp")
def jsoncpp():
    return {
        "location": Deps.GitRepo("https://github.com/open-source-parsers/jsoncpp.git", tag="1.7.2"),
        "build": ["python amalgamate.py"]
    }

#ninja has a drop in for args.h and depot_tools has only a 64 bit exectutabel
@Deps.register("ninja")
def ninja():
    if Platform.system != "Windows":
        Log.error("The '%s' platform has a ninja binary in depot tools" % (Platform.system))
        sys.exit(1)
    return {
        "location": "https://github.com/ninja-build/ninja/archive/v1.7.2.tar.gz",
        "build": ["python configure.py --bootstrap", "cp ninja.exe ../depot_tools/"]
    }

@CommandLine.option("--unit-tests")
def testCore(unitTests):
    if not unitTests:
        return
    cdir = "../build/tests/"
    if Platform.system == "Windows":
        cdir = cdir[1:]
    Tests.register([
        ("libnidiumcore-unittests", cdir)], builders=[
            Gyp("gyp/libnidiumcore-tests.gyp",
                defines={"nidium_js_disable_window_global": 1,
                         "nidium_product_define": "NIDIUM_UNIT_TESTS"})
        ])

@CommandLine.option("--asan", default=False)
def asan(asan):
    if asan:
        Konstruct.setConfigs(["asan"])
        Gyp.set("asan", 1)

@CommandLine.option("--cpu-profiling", default=False)
def profiler(profiler):
    if profiler:
        Gyp.set("profiler", 1)
        Deps.set("gperftools")
        Deps.set("pprof")

        @Konstruct.hook("postBuild")
        def profilerPostBuild(success):
            if not success:
                return

            Log.info("-------------------------------------")
            Log.info("You have enabled CPU profiling, you must set the following environement variables to enable CPU profiling when running your application : ")
            Log.info("CPUPROFILE=/tmp/profile.nidium")
            Log.info("LD_LIBRARY_PATH=" + ROOT + "/build/third-party/${LD_LIBRARY_PATH:+:}${LD_LIBRARY_PATH:-}")
            Log.info("-------------------------------------")

@CommandLine.option("--unit-tests")
def nidiumCoreTests(unitTests):
    if not unitTests:
        return

    def query(port, useSSL=False):
        import urllib2
        try:
            urllib2.urlopen("http%s://tests.nidium.com:%d/http/hello" % ("s" if useSSL else "", port)).read()
            return True
        except Exception as e:
            Log.info("Failed to contact tests server %s" % (e))
            return False

    @Konstruct.hook("preTests")
    def preNidiumCoreTests():
        if not query(8888) or not query(8443, useSSL=True):
            Utils.exit("Tests server is down. Cannot run tests.")

@CommandLine.option("--auto-tests", default=False)
def autoTestStudio(autoTests):
    if not autoTests:
        return

    @Konstruct.hook("postBuild")
    def runNidiumAutoTests(success):
        Tests.runTest(success)

if __name__ == '__main__':
    if not Builder.Gyp._defines.has_key('nidium_version'):
        Gyp.set('nidium_version', 'library')

    Gyp.setArgs("--depth ./ --include=gyp/config.gypi --include=gyp/common.gypi --include=src/libapenetwork/gyp/config.gypi")
    Gyp.set("nidium_product_define", "NIDIUM_PRODUCT_SERVER")
    Build.add(Gyp("src/libapenetwork/gyp/network.gyp"));
    Build.add(Gyp("gyp/libnidiumcore.gyp"))

    Konstruct.start()
